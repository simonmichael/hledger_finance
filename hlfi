#!/usr/bin/env bash
# hlfi - reporting tool for hledger project finances.
# Uses ./hledger.conf.
# shellcheck shell=bash disable=SC2317

set -e
cd "$(dirname "$0")"
SCRIPT=$(basename "$0")
RECENTLY="-p quarterly from 1/1 to tomorrow"

line() { echo "--------------------------------------------------------------------------------"; }

help() { # show this help
    line
    cat <<EOF
hlfi - reporting tool for hledger project finances
Usage: hlfi [COMMAND]
Commands:
$(grep -E '^\w.*\(\) *{ *#' "$SCRIPT" | sed -e 's/() *{//' | column -t -s'#')
CMD 	       run other hledger commands

Add hledger options to customise reports.
EOF
}

reports() {  # show main README reports in terminal. Add -o html for HTML.
    echo "## Yearly Assets & Liabilities"
    yal "$@"
    echo
    echo "## Yearly Revenues & Expenses"
    yrx "$@"
    echo
    echo "## This Year's Revenues & Expenses"
    tyrx "$@"
    echo

    # too wide/detailed for github
    # echo
    # bs -t "$@"
    # echo
    # is -t "$@"
    # echo
    # bs -t -Y -b2017 "$@"
    # echo
    # is -t -T -Y -b2017 "$@"
    # echo
}

barcharts() {  # show main hledger-bar charts in terminal
    b-a "$@"
    echo
    b-r "$@"
    echo
    b-x "$@"
    echo
}

linecharts() {  # show main hledger-plot charts in terminal
    l-a "$@"
    echo
    l-r "$@"
    echo
    l-x "$@"
    echo
}


# The following hledger commands also rely on ./hledger.conf.

bs() { # recent balance sheets
    hledger bs -E "$RECENTLY" "$@"
}

is() { # recent income statements
    hledger is -S "$RECENTLY" "$@"
}

a() { # recent assets
    hledger bal type:a -HE "$RECENTLY" "$@"
}

l() { # recent liabilities
    hledger bal type:l -HE "$RECENTLY" "$@"
}

r() { # recent revenues
    hledger bal type:r -S --invert "$RECENTLY" "$@"
}

x() { # recent expenses
    hledger bal type:x -S --invert "$RECENTLY" "$@"
}

yr() { # yearly revenues
    hledger bal type:r --invert -2 -YT --transpose --drop 0 "$@"
}

yx() { # yearly expenses
    hledger bal type:x --invert -2 -YT --transpose --drop 0 "$@"
}

yrx() { # yearly revenues & expenses
    hledger bal type:rx --invert -2 -YT --transpose --drop 0 "$@"
}

yal() { # yearly assets & liabilities
    hledger bal type:al -2 -HYT --transpose --drop 0 "$@"
}

tyrx() { # this year's revenue and expenses
    hledger is -b1/1 -t -S "$@"
}

b-al() { # assets/liabilities bar chart
    hledger-bar -v 200 -Y type:al -H "$@"
}

b-rx() { # revenues/expenses bar chart
    hledger-bar -v 40 -Y type:rx --invert "$@"
}

# XXX with partial workaround for https://github.com/gooofy/drawilleplot/issues/4
l-a() { # assets line chart
    hledger plot -- bal --depth=1 ^assets   --historical  --terminal --rcParams '{"figure.figsize":[8,3]}' --no-today -q --title "hledger assets" "$@" | sed 's/⠀/ /g'
}

l-r() { # revenues line chart
    hledger plot -- bal --depth=1 ^revenues --monthly --invert  --terminal --rcParams '{"figure.figsize":[8,3]}' --drawstyle 'steps-mid' --no-today -q --title "hledger monthly revenues" "$@" | sed 's/⠀/ /g'
}

l-x() { # expenses line chart
    hledger plot -- bal --depth=1 ^expenses --monthly --terminal --rcParams '{"figure.figsize":[8,3]}' --drawstyle 'steps-mid' --no-today -q --title "hledger monthly expenses" "$@" | sed 's/⠀/ /g'
}


if [[ $# -eq 0 ]]; then help                  # no args shows help
elif declare -f "$1" > /dev/null; then "$@";  # arg 1 selects a function above
else hledger "$@"; fi                         # or fall through to hledger
exit
